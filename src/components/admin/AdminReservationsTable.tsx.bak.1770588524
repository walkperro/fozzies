"use client";

import { useMemo, useState } from "react";

type Row = {
  id: string;
  created_at: string;
  name: string;
  email: string;
  phone: string | null;
  party_size: number;
  date: string;
  time: string;
  notes: string | null;
  status: string;
  source: string | null;
  archived_at?: string | null;
  deleted_at?: string | null;
};

const STATUSES = ["new", "confirmed", "declined", "completed"] as const;
const VIEWS = ["active", "archived", "all", ...STATUSES] as const;
const TIME_VIEWS = ["upcoming", "past", "allDates"] as const;

function fmt(dt: string) {
  try {
    return new Date(dt).toLocaleString();
  } catch {
    return dt;
  }
}

function toDT(r: Row) {
  const d = (r.date || "").trim();
  const t = (r.time || "").trim();
  if (!/^\d{4}-\d{2}-\d{2}$/.test(d)) return null;
  if (!/^\d{2}:\d{2}$/.test(t)) return null;
  const iso = `${d}T${t}:00`;
  const dt = new Date(iso);
  if (isNaN(dt.getTime())) return null;
  return dt;
}

export default function AdminReservationsTable({ initialRows }: { initialRows: Row[] }) {
  const [rows, setRows] = useState<Row[]>(initialRows);
  const [filter, setFilter] = useState<(typeof VIEWS)[number]>("active");
  const [timeView, setTimeView] = useState<(typeof TIME_VIEWS)[number]>("upcoming");
  const [q, setQ] = useState<string>("");
  const [busy, setBusy] = useState<string | null>(null);

  // Notify modal (single implementation)
  const [notifyModalOpen, setNotifyModalOpen] = useState(false);
  const [notifyKind, setNotifyKind] = useState<"confirmed" | "declined" | "reschedule">("confirmed");
  const [notifyMessage, setNotifyMessage] = useState("");
  const [notifyTarget, setNotifyTarget] = useState<Row | null>(null);
  const [notifyAlsoStatus, setNotifyAlsoStatus] = useState<string | null>(null);

  // Propose-time fields (for reschedule)
  const [proposeDate, setProposeDate] = useState("");
  const [proposeTime, setProposeTime] = useState("");

  function openNotifyModal(
    r: Row,
    kind: "confirmed" | "declined" | "reschedule",
    defaultMsg: string,
    alsoStatus: string | null
  ) {
    setNotifyTarget(r);
    setNotifyKind(kind);
    setNotifyMessage(defaultMsg);
    setNotifyAlsoStatus(alsoStatus);
    setProposeDate(r.date || "");
    setProposeTime(r.time || "");
    setNotifyModalOpen(true);
  }

  async function patchRow(id: string, payload: any) {
    setBusy(id);
    try {
      const res = await fetch(`/api/admin/reservations/${id}`, {
        method: "PATCH",
        headers: { "content-type": "application/json" },
        body: JSON.stringify(payload),
      });
      const j = await res.json().catch(() => ({}));
      if (!res.ok || !j.ok) throw new Error(j.error || "Update failed");
      return true;
    } catch (e) {
      console.error(e);
      alert("Could not update reservation.");
      return false;
    } finally {
      setBusy(null);
    }
  }

  async function notifyGuest(id: string, kind: "confirmed" | "declined" | "reschedule", message: string) {
    setBusy(id);
    try {
      const res = await fetch(`/api/admin/reservations/${id}/notify`, {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ kind, message }),
      });
      const j = await res.json().catch(() => ({}));
      if (!res.ok || !j.ok) throw new Error(j.error || "Notify failed");
      return true;
    } catch (e) {
      console.error(e);
      alert("Could not send email.");
      return false;
    } finally {
      setBusy(null);
    }
  }

  async function sendNotifyModal() {
    if (!notifyTarget) return;
    const r = notifyTarget;
    const msg = (notifyMessage || "").trim();
    if (!msg) {
      alert("Please enter a message.");
      return;
    }

    if (notifyAlsoStatus) {
      const ok = await patchRow(r.id, { status: notifyAlsoStatus });
      if (!ok) return;
      setRows((prev) => prev.map((x) => (x.id === r.id ? { ...x, status: notifyAlsoStatus } : x)));
    }

    let finalMsg = msg;
    if (notifyKind === "reschedule") {
      const pd = (proposeDate || "").trim();
      const pt = (proposeTime || "").trim();
      if (pd || pt) {
        finalMsg += `\n\nProposed alternative: ${pd || r.date} ${pt || r.time}`;
      }
    }

    const ok = await notifyGuest(r.id, notifyKind, finalMsg);
    if (!ok) return;

    setNotifyModalOpen(false);
    setNotifyTarget(null);
    setNotifyAlsoStatus(null);
    alert("Email sent ✅");
  }

  const filtered = useMemo(() => {
    const base = rows.filter((r) => !r.deleted_at);

    let out = base;
    if (filter === "active") out = out.filter((r) => !r.archived_at);
    else if (filter === "archived") out = out.filter((r) => !!r.archived_at);
    else if (filter !== "all") out = out.filter((r) => (r.status || "new") === filter);

    const qq = q.trim().toLowerCase();
    if (qq) {
      out = out.filter((r) => {
        const blob = `${r.name} ${r.email} ${r.phone || ""} ${r.date} ${r.time} ${r.notes || ""}`.toLowerCase();
        return blob.includes(qq);
      });
    }

    const now = new Date();
    if (timeView !== "allDates") {
      out = out.filter((r) => {
        const d = toDT(r);
        if (!d) return false;
        return timeView === "upcoming" ? d.getTime() >= now.getTime() : d.getTime() < now.getTime();
      });
    }

    out = out.slice().sort((a, b) => {
      const da = toDT(a);
      const db = toDT(b);
      const ta = da ? da.getTime() : 0;
      const tb = db ? db.getTime() : 0;

      if (timeView === "past") return tb - ta;
      if (timeView === "upcoming") return ta - tb;
      return ta - tb;
    });

    return out;
  }, [rows, filter, timeView, q]);

  async function setStatus(id: string, status: string) {
    const ok = await patchRow(id, { status });
    if (!ok) return;
    setRows((prev) => prev.map((r) => (r.id === id ? { ...r, status } : r)));
  }

  async function toggleArchive(r: Row) {
    const next = !r.archived_at;
    const ok = await patchRow(r.id, { archive: next });
    if (!ok) return;
    setRows((prev) =>
      prev.map((x) => (x.id === r.id ? { ...x, archived_at: next ? new Date().toISOString() : null } : x))
    );
  }

  async function softDelete(r: Row) {
    if (!confirm(`Soft-delete this reservation from ${r.name}?`)) return;
    const ok = await patchRow(r.id, { softDelete: true });
    if (!ok) return;
    setRows((prev) => prev.map((x) => (x.id === r.id ? { ...x, deleted_at: new Date().toISOString() } : x)));
  }

  function confirmAndNotify(r: Row) {
    const defaultMsg = `We look forward to seeing you at ${r.time} on ${r.date}.`;
    openNotifyModal(r, "confirmed", defaultMsg, "confirmed");
  }

  function declineAndNotify(r: Row) {
    const defaultMsg =
      `We couldn’t confirm ${r.time} on ${r.date}. ` +
      `Reply with another preferred time (or day) and we’ll do our best to accommodate you.`;
    openNotifyModal(r, "declined", defaultMsg, "declined");
  }

  function rescheduleAndNotify(r: Row) {
    const defaultMsg =
      `We can accommodate you, but we may need to adjust the time. ` +
      `Reply with what works best and we’ll confirm.`;
    openNotifyModal(r, "reschedule", defaultMsg, null);
  }

  return (
    <div className="p-4 sm:p-6">
      <div className="flex flex-wrap items-center gap-2">
        {VIEWS.map((k) => (
          <button
            key={k}
            onClick={() => setFilter(k)}
            className={[
              "rounded-full px-3 py-1.5 text-xs border transition",
              filter === k
                ? "border-gold bg-gold/20 text-charcoal"
                : "border-charcoal/15 bg-ivory text-softgray hover:bg-ivory/70",
            ].join(" ")}
          >
            {k.toUpperCase()}
          </button>
        ))}

        <div className="ml-auto flex flex-wrap items-center gap-2">
          {TIME_VIEWS.map((t) => (
            <button
              key={t}
              onClick={() => setTimeView(t)}
              className={[
                "rounded-full px-3 py-1.5 text-xs border transition",
                timeView === t
                  ? "border-gold bg-gold/20 text-charcoal"
                  : "border-charcoal/15 bg-ivory text-softgray hover:bg-ivory/70",
              ].join(" ")}
            >
              {t === "allDates" ? "ALL" : t.toUpperCase()}
            </button>
          ))}
          <input
            value={q}
            onChange={(e) => setQ(e.target.value)}
            placeholder="Search..."
            className="h-8 w-44 rounded-full border border-charcoal/15 bg-cream px-3 text-xs text-charcoal outline-none placeholder:text-softgray"
          />
          <div className="text-xs text-softgray">
            Showing {filtered.length} of {rows.filter((r) => !r.deleted_at).length}
          </div>
        </div>
      </div>

      <div className="mt-5 overflow-x-auto">
        <table className="w-full text-sm">
          <thead className="text-xs text-softgray">
            <tr className="border-b border-charcoal/10">
              <th className="py-2 text-left font-medium">When</th>
              <th className="py-2 text-left font-medium">Guest</th>
              <th className="py-2 text-left font-medium">Reservation</th>
              <th className="py-2 text-left font-medium">Notes</th>
              <th className="py-2 text-left font-medium">Status</th>
              <th className="py-2 text-left font-medium">Actions</th>
            </tr>
          </thead>

          <tbody className="text-charcoal">
            {filtered.map((r) => (
              <tr key={r.id} className="border-b border-charcoal/10 align-top">
                <td className="py-3 pr-3 whitespace-nowrap">{fmt(r.created_at)}</td>

                <td className="py-3 pr-3">
                  <div className="font-medium">{r.name}</div>
                  <div className="text-softgray">
                    <a className="underline" href={`mailto:${r.email}`}>{r.email}</a>
                    {r.phone ? (
                      <>
                        {" • "}
                        <a className="underline" href={`tel:${r.phone}`}>{r.phone}</a>
                      </>
                    ) : null}
                  </div>
                  {r.archived_at ? <div className="mt-1 text-[11px] text-softgray">Archived</div> : null}
                </td>

                <td className="py-3 pr-3 whitespace-nowrap">
                  {r.date} {r.time} • party {r.party_size}
                </td>

                <td className="py-3 pr-3 min-w-[220px]">
                  <div className="text-softgray">{r.notes || "—"}</div>
                </td>

                <td className="py-3 pr-3 whitespace-nowrap">
                  <span className="rounded-full border border-charcoal/15 bg-ivory px-2 py-1 text-xs">
                    {(r.status || "new").toUpperCase()}
                  </span>
                </td>

                <td className="py-3 whitespace-nowrap">
                  <div className="flex flex-wrap gap-2">
                    {STATUSES.map((s) => (
                      <button
                        key={s}
                        disabled={busy === r.id}
                        onClick={() => setStatus(r.id, s)}
                        className="rounded-full border border-gold px-3 py-1.5 text-xs text-charcoal hover:bg-gold/15 disabled:opacity-60"
                      >
                        {s}
                      </button>
                    ))}

                    <button
                      disabled={busy === r.id}
                      onClick={() => confirmAndNotify(r)}
                      className="rounded-full border border-charcoal/15 px-3 py-1.5 text-xs text-softgray hover:bg-ivory disabled:opacity-60"
                    >
                      confirm + email
                    </button>

                    <button
                      disabled={busy === r.id}
                      onClick={() => declineAndNotify(r)}
                      className="rounded-full border border-charcoal/15 px-3 py-1.5 text-xs text-softgray hover:bg-ivory disabled:opacity-60"
                    >
                      decline + email
                    </button>

                    <button
                      disabled={busy === r.id}
                      onClick={() => rescheduleAndNotify(r)}
                      className="rounded-full border border-charcoal/15 px-3 py-1.5 text-xs text-softgray hover:bg-ivory disabled:opacity-60"
                    >
                      reschedule + email
                    </button>

                    <button
                      disabled={busy === r.id}
                      onClick={() => toggleArchive(r)}
                      className="rounded-full border border-charcoal/15 px-3 py-1.5 text-xs text-softgray hover:bg-ivory disabled:opacity-60"
                    >
                      {r.archived_at ? "unarchive" : "archive"}
                    </button>

                    <button
                      disabled={busy === r.id}
                      onClick={() => softDelete(r)}
                      className="rounded-full border border-red-500/30 px-3 py-1.5 text-xs text-red-600 hover:bg-red-50 disabled:opacity-60"
                    >
                      delete
                    </button>
                  </div>
                </td>
              </tr>
            ))}

            {filtered.length === 0 && (
              <tr>
                <td className="py-10 text-center text-softgray" colSpan={6}>
                  No reservations in this view.
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>

      {notifyModalOpen && notifyTarget && (
        <div className="fixed inset-0 z-[200] flex items-center justify-center bg-charcoal/40 p-4">
          <div className="w-full max-w-2xl border border-charcoal/10 bg-cream shadow-sm">
            <div className="p-4 sm:p-6">
              <div className="text-[11px] tracking-[0.18em] text-softgray">NOTIFY GUEST</div>
              <div className="mt-2 font-serif text-2xl text-charcoal">
                {notifyTarget.name} • {notifyTarget.date} {notifyTarget.time}
              </div>

              <div className="mt-4 flex flex-wrap gap-2">
                {(["confirmed", "declined", "reschedule"] as const).map((k) => (
                  <button
                    key={k}
                    type="button"
                    onClick={() => setNotifyKind(k)}
                    className={[
                      "rounded-full px-3 py-1.5 text-xs border transition",
                      notifyKind === k
                        ? "border-gold bg-gold/20 text-charcoal"
                        : "border-charcoal/15 bg-ivory text-softgray hover:bg-ivory/70",
                    ].join(" ")}
                  >
                    {k.toUpperCase()}
                  </button>
                ))}
              </div>

              <div className="mt-4">
                <div className="text-[11px] tracking-[0.18em] text-softgray">MESSAGE</div>
                <textarea
                  value={notifyMessage}
                  onChange={(e) => setNotifyMessage(e.target.value)}
                  rows={8}
                  className="mt-1 w-full border border-charcoal/15 bg-cream px-3 py-2 text-sm text-charcoal outline-none"
                />
              </div>

              {notifyKind === "reschedule" && (
                <div className="mt-4 border border-charcoal/10 bg-ivory p-3">
                  <div className="text-[11px] tracking-[0.18em] text-softgray">PROPOSE A TIME</div>

                  <div className="mt-2 grid gap-3 sm:grid-cols-2">
                    <div>
                      <div className="text-[11px] tracking-[0.18em] text-softgray">DATE</div>
                      <input
                        type="date"
                        value={proposeDate}
                        onChange={(e) => setProposeDate(e.target.value)}
                        className="mt-1 w-full border border-charcoal/15 bg-cream px-3 py-2 text-sm text-charcoal outline-none"
                      />
                    </div>

                    <div>
                      <div className="text-[11px] tracking-[0.18em] text-softgray">TIME</div>
                      <input
                        type="time"
                        value={proposeTime}
                        onChange={(e) => setProposeTime(e.target.value)}
                        className="mt-1 w-full border border-charcoal/15 bg-cream px-3 py-2 text-sm text-charcoal outline-none"
                      />
                    </div>
                  </div>

                  <div className="mt-3 flex flex-wrap gap-2">
                    <button
                      type="button"
                      onClick={() => {
                        const pd = (proposeDate || "").trim();
                        const pt = (proposeTime || "").trim();
                        if (!pd && !pt) return;

                        setNotifyMessage((m) => {
                          const base = (m || "").replace(/\n\nProposed alternative:.*$/s, "");
                          return base + `\n\nProposed alternative: ${pd || notifyTarget.date} ${pt || notifyTarget.time}`;
                        });
                      }}
                      className="rounded-full border border-gold px-3 py-1.5 text-xs text-charcoal hover:bg-gold/15"
                    >
                      append to message
                    </button>
                  </div>
                </div>
              )}

              <div className="mt-5 flex flex-wrap gap-2">
                <button
                  type="button"
                  disabled={busy === notifyTarget.id}
                  onClick={sendNotifyModal}
                  className="rounded-full bg-gold px-4 py-2 text-sm font-semibold text-charcoal hover:opacity-90 disabled:opacity-60"
                >
                  Send Email
                </button>

                <button
                  type="button"
                  onClick={() => {
                    setNotifyModalOpen(false);
                    setNotifyTarget(null);
                    setNotifyAlsoStatus(null);
                  }}
                  className="rounded-full border border-charcoal/15 px-4 py-2 text-sm text-softgray hover:bg-ivory"
                >
                  Cancel
                </button>
              </div>

              <div className="mt-3 text-xs text-softgray">
                Confirm/Decline also updates status automatically. Reschedule only emails.
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
